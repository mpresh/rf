<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=iso-8859-1" />
    <meta http-equiv="Content-Language" content="en-us" />

    <!--<script type="text/javascript" src="{% url static 'javascript/jquery-ui-1.8.1.custom.js' %}"></script>-->
    <script type="text/javascript" src="{% url static 'javascript/jquery-1.4.2.min.js' %}" ></script>
    <!--<script type="text/javascript" src="{% url static 'javascript/jquery.tabSlideOut.v1.3.js' %}" ></script>-->
    <script type="text/javascript" src="{% url static 'javascript/myjscript.js' %}" ></script>
    <script type="text/javascript" src="{% url static 'javascript/jquery.validate.js' %}" ></script>
    <script type="text/javascript" src="{% url static 'javascript/jquery.tools.min.js' %}" ></script>

    <script type="text/javascript" src="{% url static 'javascript/jquery.cookie.js' %}" ></script>
    <script type="text/javascript" src="{% url static 'javascript/charCount.js' %}" ></script>
    <script type="text/javascript" src="{% url static 'javascript/jquery.showLoading.js' %}" ></script>	
    <script type="text/javascript" src="{% url static 'javascript/ZeroClipboard.js' %}" ></script>	

    <link rel="stylesheet" href="{% url static 'css/showLoading.css' %}" type="text/css" />	
    <link rel="stylesheet" href="{% url static 'css/blueprint/typography.css' %}" type="text/css" />	
    <link rel="stylesheet" href="{% url static 'css/overlay.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% url static 'css/landingA.css' %}" type="text/css" />


    <title>{{campaign.title}}</title>

  </head>
<body>
<div id="main">
    <div id="container">


	<div id="attendees">
	    <div id="msg">Interested</div>
	    <div id="attendees_thumbs" style="overflow: auto;">
		{% for attendee in attendees %} 
		    <a href="">
			<img class="attendeeIcon" src="{{attendee.profile_pic}}" /> 
		    </a>
		{% endfor %}
	    </div>
	</div>


        <div id="badge">
	    <h1>{{campaign.title}}</h1>
	    <span id="call2Act"><h2>By <b>Sharing</b> with friends:</h2></span>
	    <div id="facebook-login-share">
                  <script src="http://connect.facebook.net/en_US/all.js"></script>
		  <div id="fb-root"></div>
                  {% if fbuser %}
		      <img id="facebook-share" src="{% url static 'images/facebookShare_icon.png' %}"/>
		  {% else %}
		      <img id="facebook-login" src="{% url static 'images/facebookShare_icon.png' %}"/>
                  {% endif %}
	     </div>  

	     <div id="twitter-login-share">
                 {% if user %}
		     <img id="twitter-share" src="{% url static 'images/twitterShare_icon.png' %}"/>
                 {% else %}
                     <a href="{% url tauth_login %}?redirectArgs=overlayEQUALStwitter">
		         <img id="twitter-login2" src="{% url static 'images/twitterShare_icon.png' %}" />
		     </a>
                 {% endif %}
             </div>
	    <h3><p id="callMsg">{{campaign.message}}</p></h3>

	</div> <!-- badge -->


	<div id="divider">
	    <div id ="logo"><img height="35px" src="{% url static 'images/rf-logo.png' %}"></div>
	    {% if fbuser %}
	    <div id="floggedin">
	        <fb:profile-pic id="facebook-profile-image" height="30px" width="30px" uid={{fbuser.facebook_id}} linked="false" >
		</fb:profile-pic> 
		<a id="flogout" href="">logout</a>
	    </div>
	    {% endif %}
	    {% if user %}
	    <div id="tloggedin">
		<img id="twitter-profile-image" src="{{user.profile_pic}}" />
		<a id="tlogout" href="{% url tauth_logout %}">logout</a>
	    </div>
	    {% endif %}

	</div>


<div id="overlay-blogger-login" class="overlay-blogger">
	<div id="overlay-div-content1"></div>

	<div id="overlay-div-content2-facebook" >
		<div class="overlay-top">
			<img src="{% url static 'images/step2-msg.png' %}">  
		</div>
		<div id="facebook-top-msg">
			<img src="{% url static 'images/facebook-share-msg.png' %}">
		</div>
		<textarea id="overlay-textarea-facebook">{{campaign.message_share}}</textarea>
		<div id="facebook-div-feed-update"><img src="{% url static 'images/share.png' %}" id="facebook-feed-update"></div>
	</div>
	
	<div id="overlay-div-content2-twitter">
		<div class="overlay-top">
			<img src="{% url static 'images/step2-msg.png' %}">  
		</div>
		
		<div id="twitter-top-msg">
			<img src="{% url static 'images/twitter-share-msg.png' %}">
		</div>
		<textarea id="overlay-textarea-twitter" >{{campaign.message_share}}</textarea>
		<div id="twitter-div-feed-update"><img src="{% url static 'images/share.png' %}" id="twitter-feed-update"></div>

	</div>

	<div id="overlay-div-content3" >

		<div class="overlay-top"><img src="{% url static 'images/step3-msg.png' %}"></div>
		<div id="code-msg">Thanks for sharing.<BR> Here is your discount code:</div>
		<div id="code">
		    <p>{{campaign.code}}</p>
		    <div id="d_clip_container" style="position:relative">
		        <button type="button" id="d_clip_button">Copy to Clipboard</button>
		    </div>
		    <span>Redeem Here:</span><a href="{{campaign.url_redeem}}">{{campaign.url_redeem}}</a></font></div>

	</div>

</div>


</div>




<div id="ifra">
    <iframe id="ifm" src ="{{campaign.url}}" frameborder="0" width="100%" scrolling="auto">
        <p>Your browser does not support iframes.</p>
    </iframe>
</div>

<script>
// Global vars
var contentView = 0;
var shareLink = '';

function refreshAttendee()
{
	var attendee_list = "&nbsp;&nbsp;&nbsp;&nbsp; ";

	$.getJSON('{% url attendees_list campaign_id=campaign.id %}', function(data){
		$.each(data, function(index, attendee) {
                        if (attendee[3] == "facebook") {
			attendee_list += '<a target="facebook_' + attendee[2] + '" href="http://www.facebook.com/profile.php?id=' +  attendee[2]  + '"><img height="44px" style="margin-bottom: 5px; border: 3px solid blue;" src= "'+attendee[0]+'"></a>&nbsp&nbsp&nbsp;';
                        }
                        else {
                        attendee_list += '<a target="twitter_' + attendee[2] + '" href="http://twitter.com/' +  attendee[2]  + '"><img height="44px" style="margin-bottom: 5px; border: 3px solid green;" src= "'+attendee[0]+'"></a>&nbsp&nbsp&nbsp;';
                        } 
			if ((index+1) % 4==0 && index != 0)
			{
				attendee_list +="<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
			}
		});
		$('#attendees_thumbs').html(attendee_list);
	});
}

refreshAttendee();

$("#ifra").showLoading({'afterShow': function(){ setTimeout( "jQuery('#ifra').hideLoading()", 5000 );}});         


$("#overlay-blogger-login").overlay({
	expose: {
		loadSpeed: 100,
		color: '#666',
		opacity: 0.8
	},
	onLoad: function(event) {
	    // Which page to start on?
		// if twitter user logged in, show twitter page
		{% if user and overlayTwitter %}
		pageOverlay(2, 'twitter');
		{% else %} 	
	
		// if fbuser logged in
		{% if fbuser and overlayFacebook %}
		pageOverlay(2, 'facebook');
		{% else %} 
	
		// show first view with facebook and twitter login buttons
		{% if not user and not fbuser %}
		pageOverlay(1, '');
		{% else %} 	
	
		// if fbuser logged in
		{% if fbuser %}
		pageOverlay(2, 'facebook');
		{% else %} 	
	
		// if fbuser logged in
		{% if user  %}
		pageOverlay(2, 'twitter');
		{% endif %}
		{% endif %}
		{% endif %}
		{% endif %}
		{% endif %}
		if (shareLink == 'facebook') {
		    pageOverlay(2, 'facebook');
		    shareLink = '';
		}
		if (shareLink == 'twitter') {
		    pageOverlay(2, 'twitter');
		    shareLink = '';
		}

	},
	top: 170,
	left: 220
});

function pageOverlay(page, type){
    switch(page) 
    {
    case 1:
	contentView = 1;
	$('#overlay-div-content1').show();
        $('#overlay-div-content2-facebook').hide();
        $('#overlay-div-content2-twitter').hide();
        $('#overlay-div-content3').hide();
	break;
    case 2:
        contentView = 2;
	if (type == 'facebook') {
	    $('#overlay-div-content1').hide();
	    $('#overlay-div-content2-facebook').show();
	    $('#overlay-div-content2-twitter').hide();
	    $('#overlay-div-content3').hide();
	} else {
	    $('#overlay-div-content1').hide();
	    $('#overlay-div-content2-facebook').hide();
	    $('#overlay-div-content2-twitter').show();
	    $('#overlay-div-content3').hide();
	}
	break;
    case 3:
        contentView = 3;
	$('#overlay-div-content1').hide();
        $('#overlay-div-content2-facebook').hide();
        $('#overlay-div-content2-twitter').hide();
        $('#overlay-div-content3').show();
	break;
    default:
        break;
    }
}

$('#facebook-profile-image').click(function(){
	pageOverlay(2, 'facebook');
});

$('#facebook-share').click(function(){
    shareLink = 'facebook';
    $("#overlay-blogger-login").overlay().load();
});

$('#twitter-share').click(function(){
    shareLink = 'twitter';
    $("#overlay-blogger-login").overlay().load();
});

$('#twitter-profile-image').click(function(){
	pageOverlay(2, 'twitter');
});

{% if overlay or overlayTrue or overlayFacebook or overlayTwitter%}
    $("#overlay-blogger-login").overlay().load();
{% endif %}

FB.init({appId: '{{fbappid}}', status: true, cookie: true, xfbml: true});

$("#twitter-feed-update").click(function() { 
        // Show discount page
        pageOverlay(3, '');
	activateCopy();

	$.ajax({ 
                   url: "{% url campaign_tweet_invite campaign_id=campaign.id %}", 
	           dataType: "json", 
	           data: {message: $("#overlay-textarea-twitter").val(), 
		   shash: "{{shash}}"},
	           success: function (data) { $.get('{% url campaign_going_twitter campaign_id=campaign.id %}', 
	                                  function(data) { refreshAttendee(); }); },
	           beforeSend: function() { 
                         $("#code").showLoading({'afterShow': function(){ setTimeout( "jQuery('#code').hideLoading()", 3000 );}});         
                 } 

    }); 
});


$("#facebook-feed-update").click(function(){
	// Show discount page
	pageOverlay(3, '');
	activateCopy();

	$.ajax({
		url: '{% url campaign_facebook_update campaign_id=campaign.id %}', 
		dataType: "json",
		data: {message: $("#overlay-textarea-facebook").val(), shash: "{{shash}}" },

		success: function(data){
                  refreshAttendee();
		},
		beforeSend: function() {
                $("#code").showLoading({'afterShow': function(){ setTimeout( "jQuery('#code').hideLoading()", 3000 );}});         
		}
	});   

});

function activateCopy() {
    ZeroClipboard.setMoviePath( "http://collectivevip.com{% url static 'javascript/ZeroClipboard.swf' %}" ); 
    var clip = new ZeroClipboard.Client();
    clip.setText( '{{campaign.code}}' );
    clip.glue( 'd_clip_button', 'd_clip_container' );
}

$("#status_button").click(function(){
	FB.getLoginStatus(function(response) {
		//alert("HAHA" + response + inspect(response));
		if (response.session) {
			// logged in and connected user, someone you know
			//alert("logged in ");
		} else {
			// no user session available, someone you dont know
			//alert("logged out");
		}
	});
});





var requiredPerms  = ['email','user_about_me','user_birthday','user_website', 'publish_stream'];
$('#facebook-login').click(function(){
        facebook_login_click();
	//FB.getLoginStatus(function(response) {
	//alert("facebook login");
	//
	//	if (response.session) {
	//		// logged in and connected user, someone you know
	//		//alert("LOGGED IN");
	//		FB.logout(function(response) { 
        //                      facebook_login_click();
	//		});
        //        } else {
        //                 //alert("logged out");
        //                    facebook_login_click();
        //        }
	//
        //});

});

$('#flogout').click(function() 
{
	var options  = { path: '/', expires: -1 };
	$.cookie("uid", null, options);
	$.cookie("session_key", null, options);
	$.cookie("secret", null, options);
	$.cookie("expires", null, options);
	$.cookie("base_domain", null, options);
	$.cookie("access_token", null, options);
	$.cookie("sig", null, options);

	FB.getLoginStatus(function(response) {
		if (response.session) {	
			FB.logout(function(response) { 
						window.location.href   = "{% url facebook_logout_callback %}";
					});
				}
				else{
					window.location.href  = "{% url facebook_logout_callback %}";
				}
	});
});



$("#invite_popup_close").bind('click', function() {
	$('#invite_popup').hide();
	$('#tweet_msg').html("");
	ajax_loader_image();
});

$("#okay").click(function(){
	$("#badge").overlay().close();
});


//default usage
$("#overlay-textarea-twitter").charCount();
({
	allowed: 80,		
	warning: 20
});
$("#overlay-textarea-facebook").charCount();
({
	allowed: 80,		
	warning: 20
});

function pageY(elem) {
    return elem.offsetParent ? (elem.offsetTop + pageY(elem.offsetParent)) : elem.offsetTop;
}
var buffer = 30; //scroll bar buffer
function resizeIframe() {
    var height = document.documentElement.clientHeight;
    height -= pageY(document.getElementById('ifra'))+ buffer ;
    height = (height < 0) ? 0 : height;
    document.getElementById('ifm').style.height = height + 'px';
}
document.getElementById('ifm').onload=resizeIframe;
window.onresize = resizeIframe;

</script>
<script type="text/javascript" src="{% url static 'javascript/jquery.animate-shadow.js' %}" ></script>

</body>
</html>
