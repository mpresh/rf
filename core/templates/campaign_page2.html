<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=iso-8859-1" />
    <meta http-equiv="Content-Language" content="en-us" />

    <script type="text/javascript" src="{% url static 'javascript/jquery-1.4.2.min.js' %}" ></script>
    <script type="text/javascript" src="{% url static 'javascript/myjscript.js' %}" ></script>
    <script type="text/javascript" src="{% url static 'javascript/jquery.validate.js' %}" ></script>
    <script type="text/javascript" src="{% url static 'javascript/jquery.tools.min.js' %}" ></script>

    <script type="text/javascript" src="{% url static 'javascript/jquery.cookie.js' %}" ></script>
    <script type="text/javascript" src="{% url static 'javascript/charCount.js' %}" ></script>
    <script type="text/javascript" src="{% url static 'javascript/jquery.showLoading.js' %}" ></script>	
    <script type="text/javascript" src="{% url static 'javascript/ZeroClipboard.js' %}" ></script>	

    <link rel="stylesheet" href="{% url static 'css/showLoading.css' %}" type="text/css" />	
    <link rel="stylesheet" href="{% url static 'css/blueprint/typography.css' %}" type="text/css" />	
    <link rel="stylesheet" href="{% url static 'css/overlayA.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% url static 'css/landingA.css' %}" type="text/css" />


    <title>{{campaign.title}}</title>

  </head>
<body>
           <div id="campaign-title">{{campaign.title}}</div>
<div id="main">


      <div id="container">

      {% ifequal campaign.campaign_type "discount" %}

	<div id="attendees">
	    <div id="msg">Interested</div>
	    <div id="attendees_thumbs"></div>
	</div>
	<div id="attendees_slide">
	    <span>Interested</span>
	    <a id="less">Close</a>
	    <div id="attendees_expand"></div>
	</div>
        {% else %}
        <div id="raffle-prize">

       <div id="img-label">PRIZE:</div>
       {% if campaign.url_redeem %}
       <img id="img-prize" src="{{campaign.url_redeem}}"/>
       {% endif %}
        </div>
        {% endifequal %}

        <div id="badge">
	    <div id="callMsg">{{campaign.message}}</div>
	    <span id="call2Act"><h2>JUST BY <b>Sharing</b> with friends:</h2></span>
	    <div id="facebook-login-share">
                  <script src="http://connect.facebook.net/en_US/all.js"></script>
		  <div id="fb-root"></div>
                  
		      <button id="facebook-share" class="badge-button" style="cursor: pointer;" style="display:none;">
		           <img src="{% url static 'images/facebookShare_icon2.png' %}"/><span>Share</span>
		      </button>
		  
		      <button id="facebook-login" class="badge-button" style="cursor: pointer;" style="display:none;">
		           <img src="{% url static 'images/facebookShare_icon2.png' %}"/><span>Share</span>
		      </button>
                  
	     </div>  

	     <div id="twitter-login-share">
                 
		     <button id="twitter-share" class="badge-button" style="cursor: pointer;" style="display:none;">
		           <img src="{% url static 'images/twitterShare_icon2.png' %}"/><span>Share</span>
		     </button>
                 
                     <button class="badge-button" id="twitter-login" style="cursor: pointer;" style="display:none;">
		         <img src="{% url static 'images/twitterShare_icon2.png' %}" /><span>Share</span>
		     </button>
                 
             </div>

	</div> <!-- badge -->



	<div id="overlay-blogger-login" class="overlay-blogger">

	<div id="overlay-div-content2-facebook" >
                <div class="overlay-top">
                    {%ifequal campaign.campaign_type "discount" %}
                    <p>Discounts Are Better When You Share Them</p>
                     {% else %}  
                    <p>Share and win, it's that simple</p>
                    {% endifequal %}
                </div>
                <div id="facebook-top-msg">
                     {%ifequal campaign.campaign_type "discount" %}
                     <p>Share to Reveal Discount</p>
                     {% else %}  
                     <p>Share to enter contest</p>
                    {% endifequal %}
		</div>

		<div class="textarea-div">
		     <textarea id="overlay-textarea-facebook">{{campaign.message_share}}</textarea>
		</div>
		<div id="facebook-feed-update" class="share-button"><p>Share</p></div>
	</div>
	
	<div id="overlay-div-content2-twitter">
		<div class="overlay-top">
                    {%ifequal campaign.campaign_type "discount" %}
                    <p>Discounts Are Better When You Share Them</p>
                    {% else %}  
                    <p>Share and win, it's that simple</p>
                    {% endifequal %}
                </div>
                
                <div id="twitter-top-msg">
                    {%ifequal campaign.campaign_type "discount" %}
                    <p>Share to Reveal Discount</p>
                    {% else %}  
                    <p>Share to enter contest</p>
                    {% endifequal %}
		</div>

		<div class="textarea-div">
		     <textarea id="overlay-textarea-twitter" >{{campaign.message_share}}</textarea>
		</div>
		<div id="twitter-feed-update" class="share-button"><p>Share</p></div>
	</div>

	<div id="overlay-div-content3" >
		<div class="overlay-top">
                    {%ifequal campaign.campaign_type "discount" %}
                    <p>Discount Code</p>
                    {% else %}
                    <p>Successfully Entered Contest</p>
                    {% endifequal %}
                </div>

                {%ifequal campaign.campaign_type "discount" %}

		<div id="code-msg">Thanks for sharing.<BR> Here is your discount code:</div>
		<div id="code">
		    <p id="discount-code">{{campaign.code}}</p>
		    <!--<div id="d_clip_container" style="position:relative">
		        <button type="button" id="d_clip_button">Copy to Clipboard</button>
		    </div>-->
		    <span>Redeem Here:</span><br/><a href="{{campaign.url_redeem}}">{{campaign.url_redeem}}</a></font></div>
		{% else %}
                <div id="code-msg">Thanks for sharing.<BR> You have entered raffle:</div>
                <img style="margin: 20px;" id="img-prize" src="{{campaign.url_redeem}}" />

                {% endifequal %}
	</div>

</div>


</div>

	<div id="divider">
	    <div id ="logo"><img height="35px" src="{% url static 'images/rf-logo.png' %}"></div>
	    
	    <div id ="floggedin" style="display:none">
                <fb:profile-pic id="facebook-profile-image" height="30px" width="30px" uid={{fbuser.facebook_id}} linked="false" >
      </fb:profile-pic>
                <a id="flogout" href="#">logout</a>
	    </div>
	    
	    
	    <div id ="tloggedin" style="display:none">
	        <img id="twitter-profile-image" src="{{user.profile_pic}}" />
                <a id="tlogout" href="#">logout</a>
	    </div>
	    
	</div>
      <div id="divideBG"></div>


<div id="ifra">
    <iframe id="ifm" src ="{{campaign.url}}" frameborder="0" width="100%" scrolling="auto">
        <p>Your browser does not support iframes.</p>
    </iframe>
</div>

<script>
// Global vars
var contentView = 0;
var shareLink = '';

// Global vars
var facebook_app_id = '{{facebook_app_id}}';
var host = '{{host}}';
var campaign_type = '{{campaign.campaign_type}}';


{% if user %}
var user = true;
var user_id = '{{user.id}}';
$('#twitter-share').show();
$('#twitter-login').hide();
$("#tloggedin").show();
{% else %}
$('#twitter-login').show();
$('#twitter-share').hide();
var user = false;
var user_id = '';
{% endif %}

{% if fbuser %}
var fbuser = true;
var fbuser_id = '{{fbuser.id}}';
$('#facebook-share').show();
$('#facebook-login').hide();
$("#floggedin").show();
{% else %}
var fbuser = false;
var fbuser_id = '';
$('#facebook-login').show();
$('#facebook-share').hide();
{% endif %}

{% if overlayTwitter %}
var overlayTwitter = true;
{% else %}
var overlayTwitter = false;
{% endif %}
{% if overlayfacebook %}
var overlayFacebook = true;
{% else %}
var overlayFacebook = false;
{% endif %}

var shash = '{{shash}}';

var tauth_login_url = host + "{% url tauth_login %}" ;
var facebook_sync_server_url = host + "{% url ajax_facebook_sync_server %}";
var ajax_facebook_logout_url = host + "{% url ajax_facebook_logout %}";
var tauth_logout_url = host + "{% url tauth_logout %}?popup=true";
var clipboard_url = host + "{% url static 'javascript/ZeroClipboard.swf' %}";
var facebook_update_id_url = host + "{% url campaign_facebook_update campaign_id=campaign.id %}";
var campaign_tweet_invite_url = host + "{% url campaign_tweet_invite campaign_id=campaign.id %}"
var campaign_going_twitter_url = host + "{% url campaign_going_twitter campaign_id=campaign.id %}";

var ajax_check_twitter_logged_in = host + "{% url tauth_logged_in %}";
var ajax_check_facebook_logged_in = host + "{% url fauth_logged_in %}";

var facebook_api = "{{facebook_api}}";
var redirect_uri = "{{redirect_uri}}";

var scope = '{{scope}}';

var code = '{{campaign.code}}';



function refreshAttendee(limit)
{
	var attendee_list = "";
	var attendee_expand = "";

	$.getJSON('{% url attendees_list campaign_id=campaign.id %}', function(data){
		$.each(data, function(index, attendee) {
		     if ((limit > 0) && (index+1 <= limit)) {
                        if (attendee[3] == "facebook") {
			attendee_list += '<a target="facebook_' + attendee[2] + '" href="http://www.facebook.com/profile.php?id=' +  attendee[2]  + '"><img src= "'+attendee[0]+'"></a>';
                        }
                        else {
                        attendee_list += '<a target="twitter_' + attendee[2] + '" href="http://twitter.com/' +  attendee[2]  + '"><img src= "'+attendee[0]+'"></a>';
                        } 
			if ((index+1) % 5==0 && index != 0)
			{
				attendee_list +="<br />";
			}
		     } 
		     if (attendee[3] == "facebook") {
			attendee_expand += '<a target="facebook_' + attendee[2] + '" href="http://www.facebook.com/profile.php?id=' +  attendee[2]  + '"><img src= "'+attendee[0]+'"></a>';
                        }
                        else {
                        attendee_expand += '<a target="twitter_' + attendee[2] + '" href="http://twitter.com/' +  attendee[2]  + '"><img src= "'+attendee[0]+'"></a>';
                        } 
			attendee_expand +="<br />";
		});
		$('#attendees_thumbs').html(attendee_list);
		if (data.length > limit) {
		    $('#msg').html('Interested<br><a onClick="expandAttendees()">more</a>');
		}
		$('#attendees_expand').html(attendee_expand);
	});
}

refreshAttendee(15);

$("#ifra").showLoading({'afterShow': function(){ setTimeout( "jQuery('#ifra').hideLoading()", 5000 );}});         


$("#overlay-blogger-login").overlay({
	expose: {
		loadSpeed: 100,
		color: '#666',
		opacity: 0.7
	},
	onLoad: function(event) {
                // Which page to start on?
		// if twitter user logged in, show twitter page
		if (user && overlayTwitter) {
		    pageOverlay(2, 'twitter');
		}
                else {
	
		    // if fbuser logged in
		    if (fbuser && overlayFacebook) {
		        pageOverlay(2, 'facebook');
		    }
                    else {
	
		        // show first view with facebook and twitter login buttons
		        if (!user && !fbuser) {
		            pageOverlay(1, '');
		        }
                        else {
		        
		            // if fbuser logged in
		            if (fbuser) {
		                pageOverlay(2, 'facebook');
		            }
                            else { 	
		            
		                // if fbuser logged in
		                if (user) {
		                pageOverlay(2, 'twitter');
		                }
		            }
		        }
		    }
		}
            
		if (shareLink == 'facebook') {
		    pageOverlay(2, 'facebook');
		    shareLink = '';
		}
		if (shareLink == 'twitter') {
		    pageOverlay(2, 'twitter');
		    shareLink = '';
		}

	},
	top: 170,
	left: 220
});

function pageOverlay(page, type){
    switch(page) 
    {
    case 1:
	contentView = 1;
        $('#overlay-div-content2-facebook').hide();
        $('#overlay-div-content2-twitter').hide();
        $('#overlay-div-content3').hide();
	break;
    case 2:
        contentView = 2;
	if (type == 'facebook') {
	    $('#overlay-div-content2-facebook').show();
	    $('#overlay-div-content2-twitter').hide();
	    $('#overlay-div-content3').hide();
	} else {
	    $('#overlay-div-content2-facebook').hide();
	    $('#overlay-div-content2-twitter').show();
	    $('#overlay-div-content3').hide();
	}
	break;
    case 3:
        contentView = 3;
        $('#overlay-div-content2-facebook').hide();
        $('#overlay-div-content2-twitter').hide();
        $('#overlay-div-content3').show();
	break;
    default:
        break;
    }
}
$('#facebook-share').click(function(){
    shareLink = 'facebook';
    $("#overlay-blogger-login").overlay().load();
});

$('#twitter-share').click(function(){
    shareLink = 'twitter';
    $("#overlay-blogger-login").overlay().load();
});

function expandAttendees(){
    $('#attendees').hide();
    $('#attendees_slide').show();
}

$('#less').click(function(){
    $('#attendees').show();
    $('#attendees_slide').hide();
});

{% if user and overlayTwitter %}
     $("#overlay-blogger-login").overlay().load();
{% endif %}
{% if fbuser and overlayFacebook %}
     $("#overlay-blogger-login").overlay().load();
{% endif %}

FB.init({appId: '{{fbappid}}', status: true, cookie: true, xfbml: true});

$("#twitter-feed-update").click(function() { 
        // Show discount page
        pageOverlay(3, '');
	//activateCopy();

	$.ajax({ 
                   url: "{% url campaign_tweet_invite campaign_id=campaign.id %}", 
	           dataType: "json", 
	           data: {message: $("#overlay-textarea-twitter").val(), 
		   shash: "{{shash}}",
                   parent_url: location.href},
	           success: function (data) {
                                          $.get('{% url campaign_going_twitter campaign_id=campaign.id %}', 
	                                  function(data) { refreshAttendee(15); }); },
	           beforeSend: function() { 
                {%ifequal campaign.campaign_type "discount" %} 
                         $("#code").showLoading({'afterShow': function(){ setTimeout( "jQuery('#code').hideLoading()", 3000 );}});         
                {% endifequal %}
                 } 

    }); 
});


$("#facebook-feed-update").click(function(){
	// Show discount page
	pageOverlay(3, '');
	//activateCopy();
	$.ajax({
		url: '{% url campaign_facebook_update campaign_id=campaign.id %}', 
		dataType: "json",
		data: {message: $("#overlay-textarea-facebook").val(), 
                       shash: "{{shash}}",
                       parent_url: location.href},
		success: function(data){
                  refreshAttendee(15);
		},
		beforeSend: function() {
                {%ifequal campaign.campaign_type "discount" %} 
                $("#code").showLoading({'afterShow': function(){ setTimeout( "jQuery('#code').hideLoading()", 3000 );}});         
                {% endifequal %}
		}
	});   

});

function activateCopy() {
    ZeroClipboard.setMoviePath( "http://ripplefunction.com{% url static 'javascript/ZeroClipboard.swf' %}" ); 
    var clip = new ZeroClipboard.Client();
    clip.setText( '{{campaign.code}}' );
    clip.glue( 'd_clip_button', 'd_clip_container' );
}

/////////// twitter login ////////////////
$('#twitter-login').click(function(){
        var keyValuePairs = document.cookie.split(';');
       signinWin = window.open(tauth_login_url + "?popup=true", "SignIn", "width=780,height=410");
       setTimeout(CheckLoginStatusTwitter, 2000);
       signinWin.focus();
       return false;
});
function CheckLoginStatusTwitter() {
    if (signinWin.closed) {
        $.ajax({ 
            url: ajax_check_twitter_logged_in,
    	    dataType: "json", 
    	    data: {},
    	    success: function (data) {
                   //alert(JSON.stringify(data));
		    if (data["status"] == "1") {
                       $("#tloggedin").show();
                       $("#twitter-profile-image").attr("src", data["profile-img"]);
                       shareLink = 'twitter';
                       overlayType = "twitter";
                       $("#overlay-blogger-login").overlay().load();
		    }
		},			       
    	         beforeSend: function() {
                 } 
    	
    		
    	    });
    }
   else {
       setTimeout(CheckLoginStatusTwitter, 1000);
   }
}

///////////// facebook login //////////////
var requiredPerms  = ['email','user_about_me','user_birthday','user_website', 'publish_stream'];
$('#facebook-login').click(function(){
       signinWin = window.open("https://graph.facebook.com/oauth/authorize?client_id=" + facebook_api + "&redirect_uri=" + redirect_uri + "&display=popup&scope=" + scope, "SignIn", "width=780,height=410");
       setTimeout(CheckLoginStatusFacebook, 2000);
       signinWin.focus();
       return false;
});
function CheckLoginStatusFacebook() {
    if (signinWin.closed) {

    $.ajax({ 
            url: ajax_check_facebook_logged_in,
    	    dataType: "json", 
    	    data: {},
    	    success: function (data) {
	
                if (data["status"] == "1") {
                   $("#floggedin").show();
                   shareLink = 'facebook';
                   overlayType = "facebook";
                   $("#overlay-blogger-login").overlay().load();
		}
		},			       
    	         beforeSend: function() {
                 } 
    	
    		
    	    });

    
    }
    else setTimeout(CheckLoginStatusFacebook, 1000);
}


$('#flogout').click(function(){
        $.ajax({ 
                   url: ajax_facebook_logout_url,
	           dataType: "json", 
	           data: {},
	           success: function (data) { 
                       $("#floggedin").hide();
                       fbuser_id = '';
                       fbuser = false;
                       $('#facebook-share').hide();
                       $('#facebook-login').show();
                   },
	           beforeSend: function() {
       
                       var options  = { path: '/', expires: -1 };
	               $.cookie("uid", null, options);
	               $.cookie("session_key", null, options);
	               $.cookie("secret", null, options);
	               $.cookie("expires", null, options);
	               $.cookie("base_domain", null, options);
	               $.cookie("access_token", null, options);
	               $.cookie("sig", null, options);
                       FB.logout();

                 } 

        }); 
});

$('#tlogout').click(function(){
        $.ajax({ 
                   url: tauth_logout_url,
	           dataType: "json", 
	           data: {user_id: user_id},
	           success: function (data) {
                       user_id = '';
                       user = false;
                       $("#tloggedin").hide();
                       $('#twitter-share').hide();
                       $('#twitter-login').show();
                   },
	           beforeSend: function() {
                 } 

        }); 
});


$("#invite_popup_close").bind('click', function() {
	$('#invite_popup').hide();
	$('#tweet_msg').html("");
	ajax_loader_image();
});

//default usage
$("#overlay-textarea-twitter").charCount();
({
	allowed: 80,		
	warning: 20
});
$("#overlay-textarea-facebook").charCount();
({
	allowed: 80,		
	warning: 20
});

function pageY(elem) {
    return elem.offsetParent ? (elem.offsetTop + pageY(elem.offsetParent)) : elem.offsetTop;
}
var buffer = 30; //scroll bar buffer
function resizeIframe() {
    var height = document.documentElement.clientHeight;
    height -= pageY(document.getElementById('ifra'))+ buffer ;
    height = (height < 0) ? 0 : height;
    document.getElementById('ifm').style.height = height + 'px';
}
//document.getElementById('ifm').onload=resizeIframe;
//window.onresize = resizeIframe;

</script>
<script type="text/javascript" src="{% url static 'javascript/jquery.animate-shadow.js' %}" ></script>

</body>
</html>
